#!/bin/sh
# git-rehost-ipfs - rehost a git repo on ipfs

USAGE="usage: $0 <git-repo> [<name>]"

die() {
	echo >&2 "$@"
	exit 1
}

[ "$#" -gt 0 ] && [ "$#" -lt 3 ] || die "$USAGE"

url="$1"
name=$(basename "$url")
[ -n "$2" ] && name="$2"

dir=$(mktemp -d -t git-ipfs-rehost-XXXXXX)
tohost="$dir/tohost"
repo="$dir/tohost/$name"

echo "Rehosting $url"

git clone --bare "$url" "$repo" || die "Could not clone '$url'"

cd "$repo" || die "Could not cd into '$repo'"

if ls "$repo/objects/pack/"*.pack 1> /dev/null 2>&1; then
	mv objects/pack/*.pack . || die "Could not move packs"
	git unpack-objects < ./*.pack || die "Could not unpack packs"
	rm ./*.pack || die "Could not remove packs"
fi

git update-server-info || die "Could not update-server-info"

hash=$(ipfs add -q -r "$tohost" | tail -n1)
echo "done"
echo
echo "repo rehosted at http://gateway.ipfs.io/ipfs/$hash/$name"
echo "you can clone it with:"
echo 
echo "  git clone http://gateway.ipfs.io/ipfs/$hash/$name"
